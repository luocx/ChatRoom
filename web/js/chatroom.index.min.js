$(document).ready(function(){$("#send-content").on("keypress",function(e){var ctrlKey=e.ctrlKey;if(e.keyCode=="13"&&!ctrlKey){e.preventDefault();sendMessage()}else if(e.keyCode=="10"&&ctrlKey){insertAtCursor(document.getElementById("send-content"),"\n")}})$(".send-btn").on("click",function(e){sendMessage()})});function insertAtCursor(myField,myValue){if(document.selection){myField.focus();sel=document.selection.createRange();sel.text=myValue;sel.select()}else if(myField.selectionStart||myField.selectionStart=='0'){var startPos=myField.selectionStart;var endPos=myField.selectionEnd;var restoreTop=myField.scrollTop;myField.value=myField.value.substring(0,startPos)+myValue+myField.value.substring(endPos,myField.value.length);if(restoreTop>0){myField.scrollTop=restoreTop}myField.focus();myField.selectionStart=startPos+myValue.length;myField.selectionEnd=startPos+myValue.length}else{myField.value+=myValue;myField.focus()}}var weburl="ws:var ws=new WebSocket(weburl);ws.onopen=function(){};ws.onmessage=function(evt){parseOnMessage(evt.data)};ws.onclose=function(){downLine()};function getSendMessageText(content,touser,formuser){return JSON.stringify({message:{to:touser,from:formuser,content:content,time:new Date()},type:"message"})}function sendMessage(){var text=presSendMessageText($("#send-content").val());console.log(text);var touser=$("#to-userid").val();var formuser="${user.userid}";if(text==""){$("#send-content").blur();$("#send-content").val("");return}var message=getSendMessageText(text,touser,formuser);ws.send(message);$("#send-content").val("");refushChatText(JSON.parse(message).message,"POST");cacheChatText(JSON.parse(message).message,"POST")}function parseOnMessage(data){var json=JSON.parse(data);if(json.type=="message"){var nowChatUser=$("#to-userid");if(!nowChatUser.val()){}if(json.message.from=='${user.userid}'){return}if(!nowChatUser.val()||json.message.from==nowChatUser.val()){refushChatText(json.message,"GET")}cacheChatText(json.message,"GET")}else if(json.type=="notice"){refushUserlist(json.userlist)}}function cacheChatText(message,type){if(message.to==""||message.from==""){return}message.type=type;var contentIdx;var whitname;if(type=="GET"){contentIdx="${user.userid}whit"+message.from;whitname=userobjs[message.from]}else if(type=="POST"){contentIdx="${user.userid}whit"+message.to;whitname=userobjs[message.to]}if(localStorage[contentIdx]){var messages=JSON.parse(localStorage[contentIdx]).messages;messages[messages.length]=message;localStorage[contentIdx]="{\"messages\":"+JSON.stringify(messages)+"}"}else{localStorage[contentIdx]="{\"messages\":["+JSON.stringify(message)+"]}"}}function downLine(){$(".line-status").find("div").css("backgroundColor","#bbbbbb");$(".line-status").find("span").text("离线")}function refushChatWindow(chat){var uname=$(chat).data("uname");var uid=$(chat).data("uid");$("#chat-body").html("");$(".to-username").html(uname);$("#to-userid").val(uid);if(localStorage["${user.userid}whit"+uid]){var json=JSON.parse(localStorage["${user.userid}whit"+uid]);for(var index in json.messages){refushChatText(json.messages[index],json.messages[index].type)}}}function refushChatText(message,type){if(type=="GET"){var urlimg=$(".user-img"+message.from).attr("src");$("#chat-body").append("<div class=\"get-row row\">"+"                                <div class=\"msg-row col-md-1 col-xs-2\">"+"                                    <img src=\""+urlimg+"\" alt=\""+message.from+"\"  class=\"img-rounded img-responsive center-block\"/>"+"                                </div>"+"                                <div class=\"col-md-11 col-xs-10\">"+"                                    <div class=\"row\"><span>"+userobjs[message.from]+"</span></div>"+"                                    <div class=\"row\"><p class=\"msg-row msg-text get-message text-left\">"+presGetMessageText(message.content)+"</p></div>"+"                                </div>"+"                            </div>")}else if(type=="POST"){$("#chat-body").append("<div class=\"send-row row\">"+"                                    <div class=\"col-md-11 col-xs-10  text-right\">"+"                                       <p class=\"msg-row msg-text send-message text-left \">"+presGetMessageText(message.content)+"</p>"+"                                    </div>"+"                                    <div class=\"msg-row col-md-1 col-xs-2\">"+"                                        <img src=\"${bspath}/${user.imgurl}\" alt=\""+message.from+"\"  class=\"img-rounded img-responsive center-block\"/>"+"                                    </div>"+"                                </div>")}$(".chat-panel").scrollTop($("#chat-body").height())}function presSendMessageText(text){text=text.replace(/[<]/g,'<').replace(/[>]/g,'>');text=text.replace(/[\r\n]/g,'<br>').trim();return text}function presGetMessageText(text){var linecout=30;if(text.length/linecout>1){var count=parseInt(text.length/linecout);while(count>0){if(text.substring(count*linecout,text.length).indexOf("<br>")==-1){text=text.substring(0,count*linecout)+"<br>"+text.substring(count*linecout,text.length)}count--}}return text}var userobjs=new Object();function refushUserlist(userlist){$("#user-list-panel").html("");var addUser=function(username,userid,imgurl,type){var type_class="";if(type=="publicroom"){type_class="glyphicon glyphicon-heart"}var userrow=" <a href=\"#\" class=\"list-group-item\" data-uname=\""+username+"\" data-uid  =\""+userid+"\" onclick='refushChatWindow(this);'>"+"                        <div class=\"row\">"+"                            <div class=\"col-md-3 col-xs-4\">"+"                                <img src=\"${bspath}/"+imgurl+"\" alt=\"\"  class=\"user-img"+userid+" img-rounded img-responsive center-block\"/>"+"                            </div>"+"                            <div class=\"col-md-9 col-xs-8\">"+"                                <h4>"+username+"<span class=\""+type_class+"\"></span></h4>"+"                            </div>"+"                        </div>"+"                    </a>";$("#user-list-panel").append(userrow)}addUser('公共频道','','','publicroom');for(var index in userlist){var imgurl=userlist[index].imgurl;var username=userlist[index].username;var userid=userlist[index].userid;userobjs[userid]=username;if("${user.userid}"==userid){username+="(我)"}if(!imgurl){imgurl="${bspath}/images/user/timg.jpg"}addUser(username,userid,imgurl,'')}}